import pandas as pd
import oracledb

# Usar modo thin (no requiere Oracle Client instalado)
oracledb.defaults.config_dir = ""

USERNAME = 'DEIASSMVP'
PASSWORD = 'Kp51xVic'
HOST = '107.104.192.121'
PORT = '60493'
SERVICE_NAME = 'odis1ass'

EXCEL_FILE = 'C:/Users/x919989/SOURCES/ScriptVictorRuiz/Excels/ACC_USERS_REGISTERED 1.xlsx'
TABLE_NAME = 'ACC_USERS_REGISTERED'

COLUMNS = ['USER_ID', 'USER_NAME', 'USER_SURNAME', 'ACTIVE']

EXCLUDE_COLUMN = None
EXCLUDE_VALUES = None

def main():
    try:
        print("Leyendo Excel...")
        df = pd.read_excel(EXCEL_FILE, engine='openpyxl')
        
        if COLUMNS:
            df = df[COLUMNS]
            column_list = COLUMNS
        else:
            column_list = list(df.columns)
        
        print(f"Total filas en Excel: {len(df)}")
        print(f"Columnas a insertar: {column_list}")
        
        if EXCLUDE_COLUMN and EXCLUDE_VALUES:
            df = df[~df[EXCLUDE_COLUMN].isin(EXCLUDE_VALUES)]
            print(f"Filas después de filtrar: {len(df)}")
        
        print("Conectando a Oracle...")
        connection = oracledb.connect(
            user=USERNAME, 
            password=PASSWORD, 
            host=HOST,
            port=PORT,
            sid=SERVICE_NAME
        )
        cursor = connection.cursor()
        
        placeholders = ', '.join([f':{i+1}' for i in range(len(column_list))])
        column_names = ', '.join(column_list)
        sql = f"MERGE INTO {TABLE_NAME} t USING (SELECT {placeholders} FROM dual) s ON (t.USER_ID = s.:1) WHEN NOT MATCHED THEN INSERT ({column_names}) VALUES ({placeholders})"
        
        print("Insertando datos...")
        inserted = 0
        for index, row in df.iterrows():
            try:
                values = [None if pd.isna(val) else val for val in row.values]
                cursor.execute(sql, values)
                inserted += 1
            except Exception as e:
                if "ORA-00001" in str(e):
                    print(f"Fila {index + 1}: Registro duplicado, saltando...")
                else:
                    print(f"Error en fila {index + 1}: {e}")
        
        connection.commit()
        cursor.close()
        connection.close()
        
        print(f"¡Completado! Insertadas {inserted} filas")
        
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    main()
